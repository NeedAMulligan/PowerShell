# Define custom exit codes
# 0    = Success
# 1001 = Elevated Privileges Missing

# Check for Administrator privileges (Required for Repair and Log access)
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Warning "This script must be run as an Administrator."
    exit 1001
}

# 1. Spawn a new Administrator PowerShell window to tail the CBS log
# We use -Tail 10 to ignore old log entries and focus on the current process
Start-Process powershell.exe -ArgumentList "-NoProfile -Command `& {Get-Content -Path 'C:\Windows\Logs\CBS\CBS.log' -Tail 10 -Wait}`" -Verb RunAs

# 2. Execute the Repair-WindowsImage command in the current window
Write-Host "Starting Windows Image Repair (RestoreHealth)..." -ForegroundColor Yellow
Write-Host "Real-time servicing logs are now visible in the secondary window." -ForegroundColor Cyan

Repair-WindowsImage -Online -RestoreHealth

Write-Host "Process complete. You may now close the log monitoring window." -ForegroundColor Green

exit 0
